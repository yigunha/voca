<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìë™ ì´ë©”ì¼ ì „ì†¡ ìŒì„± ë…¹ìŒê¸°</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f0f2f5;
            padding: 1rem;
            box-sizing: border-box;
        }

        .container {
            background-color: #ffffff;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: 100%;
            max-width: 500px;
            box-sizing: border-box;
        }

        h1 {
            color: #333;
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
        }

        .permission-check {
            background-color: #e8f4f8;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .controls button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 1rem 2rem;
            margin: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
            min-width: 140px;
            touch-action: manipulation;
        }

        .controls button:hover:not(:disabled) {
            background-color: #0056b3;
            transform: translateY(-1px);
        }

        .controls button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            transform: none;
        }

        .controls button.recording {
            background-color: #dc3545;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .audio-container {
            margin-top: 2rem;
        }

        audio {
            width: 100%;
            margin-top: 1rem;
        }

        .status {
            margin-top: 1rem;
            padding: 0.5rem;
            border-radius: 4px;
            min-height: 1.5rem;
        }

        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
        }

        .status.success {
            background-color: #d4edda;
            color: #155724;
        }

        .status.error {
            background-color: #f8d7da;
            color: #721c24;
        }

        .troubleshooting {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            text-align: left;
            font-size: 0.9rem;
        }

        .troubleshooting h4 {
            margin-top: 0;
            color: #856404;
        }

        .troubleshooting ul {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
        }

        .device-info {
            font-size: 0.8rem;
            color: #666;
            margin-top: 1rem;
            padding: 0.5rem;
            background-color: #f8f9fa;
            border-radius: 4px;
        }

        @media (max-width: 480px) {
            .container {
                padding: 1.5rem;
            }
            
            .controls button {
                width: 100%;
                margin: 0.25rem 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ™ï¸ ìŒì„± ë…¹ìŒ í›„ ìë™ ì „ì†¡</h1>
        
        <div class="permission-check">
            <strong>ğŸ“± ëª¨ë°”ì¼ ì‚¬ìš© ì‹œ ì£¼ì˜ì‚¬í•­:</strong><br>
            HTTPS í™˜ê²½ì—ì„œë§Œ ì‘ë™í•©ë‹ˆë‹¤
        </div>

        <div class="controls">
            <button id="permissionButton">ğŸ¤ ë§ˆì´í¬ ê¶Œí•œ í™•ì¸</button>
            <button id="recordButton" disabled>ë…¹ìŒ ì‹œì‘</button>
            <button id="stopButton" disabled>ë…¹ìŒ ì¤‘ì§€</button>
        </div>

        <div class="audio-container">
            <h3>ë…¹ìŒëœ ì˜¤ë””ì˜¤:</h3>
            <audio id="audioPlayer" controls style="display: none;"></audio>
        </div>

        <div id="status" class="status"></div>

        <div class="device-info">
            <div id="deviceInfo"></div>
        </div>

        <div class="troubleshooting">
            <h4>ğŸ”§ ë¬¸ì œ í•´ê²° ë°©ë²•</h4>
            <ul>
                <li><strong>HTTPS í•„ìˆ˜:</strong> HTTPì—ì„œëŠ” ì‘ë™í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤</li>
                <li><strong>ê¶Œí•œ í—ˆìš©:</strong> ë¸Œë¼ìš°ì €ì—ì„œ ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”</li>
                <li><strong>Chrome/Safari ê¶Œì¥:</strong> ìµœì‹  ë²„ì „ ì‚¬ìš©</li>
                <li><strong>iOS:</strong> Safari 11+ í•„ìš”</li>
                <li><strong>Android:</strong> Chrome 47+ í•„ìš”</li>
            </ul>
        </div>
    </div>

    <script>
        const permissionButton = document.getElementById('permissionButton');
        const recordButton = document.getElementById('recordButton');
        const stopButton = document.getElementById('stopButton');
        const audioPlayer = document.getElementById('audioPlayer');
        const status = document.getElementById('status');
        const deviceInfo = document.getElementById('deviceInfo');

        let mediaRecorder;
        let audioChunks = [];
        let stream = null;

        // íŒŒì¼ì„ ë³´ë‚¼ ì´ë©”ì¼ ì£¼ì†Œ ì§€ì •
        const DESTINATION_EMAIL = "your-email@example.com"; 
        
        // ì„œë²„ë¦¬ìŠ¤ í•¨ìˆ˜ ì—”ë“œí¬ì¸íŠ¸ ì§€ì • (Vercel ë“±)
        const SERVER_ENDPOINT = "/api/send-email"; 

        // ë””ë°”ì´ìŠ¤ ì •ë³´ í‘œì‹œ
        function displayDeviceInfo() {
            const userAgent = navigator.userAgent;
            const isHTTPS = location.protocol === 'https:';
            const isMobile = /Mobile|Android|iPhone|iPad|iPod/i.test(userAgent);
            const isChrome = /Chrome/i.test(userAgent);
            const isSafari = /Safari/i.test(userAgent) && !isChrome;
            
            deviceInfo.innerHTML = `
                <strong>í™˜ê²½ ì •ë³´:</strong><br>
                ğŸ“± ëª¨ë°”ì¼: ${isMobile ? 'ì˜ˆ' : 'ì•„ë‹ˆì˜¤'} | 
                ğŸ”’ HTTPS: ${isHTTPS ? 'ì˜ˆ' : 'ì•„ë‹ˆì˜¤'} | 
                ğŸŒ ë¸Œë¼ìš°ì €: ${isChrome ? 'Chrome' : isSafari ? 'Safari' : 'ê¸°íƒ€'}<br>
                ğŸ¤ MediaRecorder ì§€ì›: ${typeof MediaRecorder !== 'undefined' ? 'ì˜ˆ' : 'ì•„ë‹ˆì˜¤'}
            `;
        }

        // ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
        function setStatus(message, type = 'info') {
            status.textContent = message;
            status.className = `status ${type}`;
        }

        // ë§ˆì´í¬ ê¶Œí•œ í™•ì¸ ë° ìš”ì²­
        async function checkMicrophonePermission() {
            setStatus('ë§ˆì´í¬ ê¶Œí•œì„ í™•ì¸í•˜ëŠ” ì¤‘...', 'info');
            
            try {
                // HTTPS í™•ì¸
                if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                    throw new Error('HTTPS ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤. HTTPì—ì„œëŠ” ë§ˆì´í¬ ì ‘ê·¼ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.');
                }

                // MediaRecorder ì§€ì› í™•ì¸
                if (typeof MediaRecorder === 'undefined') {
                    throw new Error('ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ë…¹ìŒì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }

                // ë§ˆì´í¬ ê¶Œí•œ ìš”ì²­
                stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                        sampleRate: 44100
                    } 
                });
                
                setStatus('âœ… ë§ˆì´í¬ ê¶Œí•œì´ í—ˆìš©ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                recordButton.disabled = false;
                permissionButton.textContent = 'âœ… ê¶Œí•œ í™•ì¸ ì™„ë£Œ';
                permissionButton.disabled = true;
                
                return true;
            } catch (error) {
                console.error('ë§ˆì´í¬ ì ‘ê·¼ ì˜¤ë¥˜:', error);
                let errorMessage = 'ë§ˆì´í¬ ì ‘ê·¼ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ';
                
                if (error.name === 'NotAllowedError') {
                    errorMessage += 'ì‚¬ìš©ìê°€ ê¶Œí•œì„ ê±°ë¶€í–ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.';
                } else if (error.name === 'NotFoundError') {
                    errorMessage += 'ë§ˆì´í¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                } else if (error.name === 'NotSupportedError') {
                    errorMessage += 'ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                } else {
                    errorMessage += error.message;
                }
                
                setStatus(errorMessage, 'error');
                return false;
            }
        }

        // ë…¹ìŒì´ ëë‚˜ë©´ íŒŒì¼ì„ ì„œë²„ë¡œ ì „ì†¡í•˜ëŠ” í•¨ìˆ˜
        async function sendAudioFile(audioBlob) {
            setStatus('íŒŒì¼ì„ ì„œë²„ë¡œ ì „ì†¡ ì¤‘...', 'info');

            const formData = new FormData();
            formData.append('audio', audioBlob, 'recorded_audio.webm');
            formData.append('email', DESTINATION_EMAIL);

            try {
                const response = await fetch(SERVER_ENDPOINT, {
                    method: 'POST',
                    body: formData,
                });

                if (response.ok) {
                    setStatus('ğŸ“§ ì´ë©”ì¼ ì „ì†¡ ì„±ê³µ!', 'success');
                } else {
                    setStatus('âŒ ì´ë©”ì¼ ì „ì†¡ ì‹¤íŒ¨. ì„œë²„ ì˜¤ë¥˜.', 'error');
                }
            } catch (error) {
                console.error('ì „ì†¡ ì˜¤ë¥˜:', error);
                setStatus('ğŸŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        permissionButton.addEventListener('click', checkMicrophonePermission);

        recordButton.addEventListener('click', async () => {
            try {
                if (!stream) {
                    const success = await checkMicrophonePermission();
                    if (!success) return;
                }

                // MediaRecorder ì„¤ì • (ëª¨ë°”ì¼ í˜¸í™˜ì„± ê°œì„ )
                const options = {
                    mimeType: MediaRecorder.isTypeSupported('audio/webm;codecs=opus') ? 'audio/webm;codecs=opus' :
                              MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' :
                              MediaRecorder.isTypeSupported('audio/mp4') ? 'audio/mp4' : ''
                };

                mediaRecorder = new MediaRecorder(stream, options);
                audioChunks = [];

                mediaRecorder.ondataavailable = event => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = () => {
                    const mimeType = mediaRecorder.mimeType || 'audio/webm';
                    const audioBlob = new Blob(audioChunks, { type: mimeType });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    
                    audioPlayer.src = audioUrl;
                    audioPlayer.style.display = 'block';

                    // ë…¹ìŒì´ ëë‚˜ë©´ ìë™ìœ¼ë¡œ ì „ì†¡ í•¨ìˆ˜ í˜¸ì¶œ
                    sendAudioFile(audioBlob);
                };

                mediaRecorder.onerror = (event) => {
                    console.error('MediaRecorder ì˜¤ë¥˜:', event.error);
                    setStatus('âŒ ë…¹ìŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                };

                // ë…¹ìŒ ì‹œì‘
                mediaRecorder.start(100); // 100msë§ˆë‹¤ ë°ì´í„° ìˆ˜ì§‘
                setStatus('ğŸ™ï¸ ë…¹ìŒ ì¤‘... (ì¤‘ì§€ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì™„ë£Œ)', 'info');
                
                recordButton.disabled = true;
                recordButton.classList.add('recording');
                stopButton.disabled = false;

            } catch (err) {
                console.error('ë…¹ìŒ ì‹œì‘ ì˜¤ë¥˜:', err);
                setStatus('âŒ ë…¹ìŒ ì‹œì‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + err.message, 'error');
            }
        });

        stopButton.addEventListener('click', () => {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                setStatus('â¹ï¸ ë…¹ìŒì„ ì¤‘ì§€í•˜ëŠ” ì¤‘...', 'info');
                
                recordButton.disabled = false;
                recordButton.classList.remove('recording');
                stopButton.disabled = true;

                // ìŠ¤íŠ¸ë¦¼ ì •ë¦¬ (ì„ íƒì‚¬í•­: ë…¹ìŒ ì™„ì „ ì¢…ë£Œ ì‹œ)
                // if (stream) {
                //     stream.getTracks().forEach(track => track.stop());
                //     stream = null;
                // }
            }
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë””ë°”ì´ìŠ¤ ì •ë³´ í‘œì‹œ
        displayDeviceInfo();

        // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ìŠ¤íŠ¸ë¦¼ ì •ë¦¬
        window.addEventListener('beforeunload', () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>
</html>