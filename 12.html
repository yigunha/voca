<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>자동 이메일 전송 음성 녹음기</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f0f2f5;
            padding: 1rem;
            box-sizing: border-box;
        }

        .container {
            background-color: #ffffff;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: 100%;
            max-width: 500px;
            box-sizing: border-box;
        }

        h1 {
            color: #333;
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
        }

        .permission-check {
            background-color: #e8f4f8;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .controls button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 1rem 2rem;
            margin: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
            min-width: 140px;
            touch-action: manipulation;
        }

        .controls button:hover:not(:disabled) {
            background-color: #0056b3;
            transform: translateY(-1px);
        }

        .controls button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            transform: none;
        }

        .controls button.recording {
            background-color: #dc3545;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .audio-container {
            margin-top: 2rem;
        }

        audio {
            width: 100%;
            margin-top: 1rem;
        }

        .status {
            margin-top: 1rem;
            padding: 0.5rem;
            border-radius: 4px;
            min-height: 1.5rem;
        }

        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
        }

        .status.success {
            background-color: #d4edda;
            color: #155724;
        }

        .status.error {
            background-color: #f8d7da;
            color: #721c24;
        }

        .troubleshooting {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            text-align: left;
            font-size: 0.9rem;
        }

        .troubleshooting h4 {
            margin-top: 0;
            color: #856404;
        }

        .troubleshooting ul {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
        }

        .device-info {
            font-size: 0.8rem;
            color: #666;
            margin-top: 1rem;
            padding: 0.5rem;
            background-color: #f8f9fa;
            border-radius: 4px;
        }

        @media (max-width: 480px) {
            .container {
                padding: 1.5rem;
            }
            
            .controls button {
                width: 100%;
                margin: 0.25rem 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎙️ 음성 녹음 후 자동 전송</h1>
        
        <div class="permission-check">
            <strong>📱 모바일 사용 시 주의사항:</strong><br>
            HTTPS 환경에서만 작동합니다
        </div>

        <div class="controls">
            <button id="permissionButton">🎤 마이크 권한 확인</button>
            <button id="recordButton" disabled>녹음 시작</button>
            <button id="stopButton" disabled>녹음 중지</button>
        </div>

        <div class="audio-container">
            <h3>녹음된 오디오:</h3>
            <audio id="audioPlayer" controls style="display: none;"></audio>
        </div>

        <div id="status" class="status"></div>

        <div class="device-info">
            <div id="deviceInfo"></div>
        </div>

        <div class="troubleshooting">
            <h4>🔧 문제 해결 방법</h4>
            <ul>
                <li><strong>HTTPS 필수:</strong> HTTP에서는 작동하지 않습니다</li>
                <li><strong>권한 허용:</strong> 브라우저에서 마이크 권한을 허용해주세요</li>
                <li><strong>Chrome/Safari 권장:</strong> 최신 버전 사용</li>
                <li><strong>iOS:</strong> Safari 11+ 필요</li>
                <li><strong>Android:</strong> Chrome 47+ 필요</li>
            </ul>
        </div>
    </div>

    <script>
        const permissionButton = document.getElementById('permissionButton');
        const recordButton = document.getElementById('recordButton');
        const stopButton = document.getElementById('stopButton');
        const audioPlayer = document.getElementById('audioPlayer');
        const status = document.getElementById('status');
        const deviceInfo = document.getElementById('deviceInfo');

        let mediaRecorder;
        let audioChunks = [];
        let stream = null;

        // 파일을 보낼 이메일 주소 지정
        const DESTINATION_EMAIL = "your-email@example.com"; 
        
        // 서버리스 함수 엔드포인트 지정 (Vercel 등)
        const SERVER_ENDPOINT = "/api/send-email"; 

        // 디바이스 정보 표시
        function displayDeviceInfo() {
            const userAgent = navigator.userAgent;
            const isHTTPS = location.protocol === 'https:';
            const isMobile = /Mobile|Android|iPhone|iPad|iPod/i.test(userAgent);
            const isChrome = /Chrome/i.test(userAgent);
            const isSafari = /Safari/i.test(userAgent) && !isChrome;
            
            deviceInfo.innerHTML = `
                <strong>환경 정보:</strong><br>
                📱 모바일: ${isMobile ? '예' : '아니오'} | 
                🔒 HTTPS: ${isHTTPS ? '예' : '아니오'} | 
                🌐 브라우저: ${isChrome ? 'Chrome' : isSafari ? 'Safari' : '기타'}<br>
                🎤 MediaRecorder 지원: ${typeof MediaRecorder !== 'undefined' ? '예' : '아니오'}
            `;
        }

        // 상태 메시지 표시
        function setStatus(message, type = 'info') {
            status.textContent = message;
            status.className = `status ${type}`;
        }

        // 마이크 권한 확인 및 요청
        async function checkMicrophonePermission() {
            setStatus('마이크 권한을 확인하는 중...', 'info');
            
            try {
                // HTTPS 확인
                if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                    throw new Error('HTTPS 연결이 필요합니다. HTTP에서는 마이크 접근이 불가능합니다.');
                }

                // MediaRecorder 지원 확인
                if (typeof MediaRecorder === 'undefined') {
                    throw new Error('이 브라우저는 음성 녹음을 지원하지 않습니다.');
                }

                // 마이크 권한 요청
                stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                        sampleRate: 44100
                    } 
                });
                
                setStatus('✅ 마이크 권한이 허용되었습니다!', 'success');
                recordButton.disabled = false;
                permissionButton.textContent = '✅ 권한 확인 완료';
                permissionButton.disabled = true;
                
                return true;
            } catch (error) {
                console.error('마이크 접근 오류:', error);
                let errorMessage = '마이크 접근에 실패했습니다: ';
                
                if (error.name === 'NotAllowedError') {
                    errorMessage += '사용자가 권한을 거부했습니다. 브라우저 설정에서 마이크 권한을 허용해주세요.';
                } else if (error.name === 'NotFoundError') {
                    errorMessage += '마이크를 찾을 수 없습니다.';
                } else if (error.name === 'NotSupportedError') {
                    errorMessage += '이 브라우저에서는 지원되지 않습니다.';
                } else {
                    errorMessage += error.message;
                }
                
                setStatus(errorMessage, 'error');
                return false;
            }
        }

        // 녹음이 끝나면 파일을 서버로 전송하는 함수
        async function sendAudioFile(audioBlob) {
            setStatus('파일을 서버로 전송 중...', 'info');

            const formData = new FormData();
            formData.append('audio', audioBlob, 'recorded_audio.webm');
            formData.append('email', DESTINATION_EMAIL);

            try {
                const response = await fetch(SERVER_ENDPOINT, {
                    method: 'POST',
                    body: formData,
                });

                if (response.ok) {
                    setStatus('📧 이메일 전송 성공!', 'success');
                } else {
                    setStatus('❌ 이메일 전송 실패. 서버 오류.', 'error');
                }
            } catch (error) {
                console.error('전송 오류:', error);
                setStatus('🌐 네트워크 오류로 전송에 실패했습니다.', 'error');
            }
        }

        // 이벤트 리스너
        permissionButton.addEventListener('click', checkMicrophonePermission);

        recordButton.addEventListener('click', async () => {
            try {
                if (!stream) {
                    const success = await checkMicrophonePermission();
                    if (!success) return;
                }

                // MediaRecorder 설정 (모바일 호환성 개선)
                const options = {
                    mimeType: MediaRecorder.isTypeSupported('audio/webm;codecs=opus') ? 'audio/webm;codecs=opus' :
                              MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' :
                              MediaRecorder.isTypeSupported('audio/mp4') ? 'audio/mp4' : ''
                };

                mediaRecorder = new MediaRecorder(stream, options);
                audioChunks = [];

                mediaRecorder.ondataavailable = event => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = () => {
                    const mimeType = mediaRecorder.mimeType || 'audio/webm';
                    const audioBlob = new Blob(audioChunks, { type: mimeType });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    
                    audioPlayer.src = audioUrl;
                    audioPlayer.style.display = 'block';

                    // 녹음이 끝나면 자동으로 전송 함수 호출
                    sendAudioFile(audioBlob);
                };

                mediaRecorder.onerror = (event) => {
                    console.error('MediaRecorder 오류:', event.error);
                    setStatus('❌ 녹음 중 오류가 발생했습니다.', 'error');
                };

                // 녹음 시작
                mediaRecorder.start(100); // 100ms마다 데이터 수집
                setStatus('🎙️ 녹음 중... (중지 버튼을 눌러 완료)', 'info');
                
                recordButton.disabled = true;
                recordButton.classList.add('recording');
                stopButton.disabled = false;

            } catch (err) {
                console.error('녹음 시작 오류:', err);
                setStatus('❌ 녹음 시작에 실패했습니다: ' + err.message, 'error');
            }
        });

        stopButton.addEventListener('click', () => {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                setStatus('⏹️ 녹음을 중지하는 중...', 'info');
                
                recordButton.disabled = false;
                recordButton.classList.remove('recording');
                stopButton.disabled = true;

                // 스트림 정리 (선택사항: 녹음 완전 종료 시)
                // if (stream) {
                //     stream.getTracks().forEach(track => track.stop());
                //     stream = null;
                // }
            }
        });

        // 페이지 로드 시 디바이스 정보 표시
        displayDeviceInfo();

        // 페이지 언로드 시 스트림 정리
        window.addEventListener('beforeunload', () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>
</html>