<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>한국어 원고지</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Malgun Gothic', sans-serif;
            padding: 20px;
            background-color: #1a1a1a;
            color: #e0e0e0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #2d2d2d;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.5);
        }
        h1 {
            margin-bottom: 20px;
            color: #ffffff;
            text-align: center;
        }
        .setup-area {
            padding: 20px;
            background-color: #3d3d3d;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
        }
        .setup-area label {
            font-weight: bold;
            margin-right: 10px;
            font-size: 16px;
            color: #ffffff;
        }
        .setup-area input[type="text"] {
            padding: 8px 15px;
            border: 1px solid #555;
            border-radius: 3px;
            font-size: 16px;
            margin-right: 20px;
            background-color: #4a4a4a;
            color: #ffffff;
            width: 200px;
        }
        .setup-area select {
            padding: 8px 15px;
            border: 1px solid #555;
            border-radius: 3px;
            font-size: 16px;
            margin-right: 20px;
            background-color: #4a4a4a;
            color: #ffffff;
        }
        .setup-area button {
            padding: 10px 30px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }
        .setup-area button:hover {
            background-color: #1976D2;
        }
        .action-buttons {
            margin-top: 30px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
            padding: 20px;
            background-color: #3d3d3d;
            border-radius: 5px;
        }
        .action-buttons button {
            padding: 10px 25px;
            border: none;
            border-radius: 5px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
        }
        .save-btn {
            background-color: #4CAF50;
            color: white;
        }
        .save-btn:hover {
            background-color: #45a049;
        }
        .load-btn {
            background-color: #FF9800;
            color: white;
        }
        .load-btn:hover {
            background-color: #e68900;
        }
        .copy-btn {
            background-color: #9C27B0;
            color: white;
        }
        .copy-btn:hover {
            background-color: #7B1FA2;
        }
        .supabase-save-btn {
            background-color: #3B82F6;
            color: white;
        }
        .supabase-save-btn:hover {
            background-color: #2563EB;
        }
        .supabase-load-btn {
            background-color: #10B981;
            color: white;
        }
        .supabase-load-btn:hover {
            background-color: #059669;
        }
        .logout-btn {
            background-color: #EF4444;
            color: white;
        }
        .logout-btn:hover {
            background-color: #DC2626;
        }
        .file-input {
            display: none;
        }
        .info {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #3d3d3d;
            border-left: 4px solid #2196F3;
            font-size: 14px;
            line-height: 1.8;
            color: #e0e0e0;
        }
        .info.hide {
            display: none;
        }
        .work-area {
            display: none;
        }
        .work-area.show {
            display: block;
        }
        .manuscript-paper {
            display: grid;
            gap: 0;
            margin: 0 auto 20px;
            border: 2px solid #555;
            background-color: #2d2d2d;
            padding: 10px;
            width: fit-content;
        }
        .manuscript-paper.cols-20 {
            grid-template-columns: repeat(20, 40px);
        }
        .manuscript-paper.cols-25 {
            grid-template-columns: repeat(25, 40px);
        }
        .cell {
            width: 40px;
            height: 40px;
            border: 1px solid #555;
            position: relative;
            background-color: #1a1a1a;
            cursor: text;
        }
        .cell.active {
            background-color: #1e3a5f;
            border: 2px solid #4CAF50;
        }
        .cell.first-cell {
            background-color: #3d1f1f;
        }
        .cell.last-cell {
            background-color: #1f2d3d;
        }
        .cell.hundred-mark {
            background-color: #3d3d1f;
        }
        .cell::before, .prev-content::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 1px;
            height: 100%;
            background-color: #404040;
            z-index: 0;
        }
        .cell::after, .prev-content::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            height: 1px;
            background-color: #404040;
            z-index: 0;
        }
        .cell-content {
            position: relative;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        .preview-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 22px;
            color: #4CAF50;
            opacity: 0.5;
            pointer-events: none;
            z-index: 10;
        }
        .preview-two-chars {
            font-size: 20px;
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 7px;
            color: #4CAF50;
            opacity: 0.5;
            pointer-events: none;
            z-index: 10;
        }
        .char-main {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 22px;
            color: #ffffff;
        }
        .char-punctuation-single {
            position: absolute;
            top: 50%;
            left: 35%;
            transform: translate(-50%, -50%);
            font-size: 22px;
            color: #ffffff;
        }
        .two-chars {
            font-size: 20px;
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 7px;
            color: #ffffff;
        }
        .char-punctuation {
            position: absolute;
            font-size: 16px;
            color: #ffffff;
        }
        .char-punctuation.period, .char-punctuation.comma {
            bottom: 3px;
            left: 3px;
        }
        .char-punctuation.period.right, .char-punctuation.comma.right {
            bottom: 3px;
            left: auto;
            right: 3px;
        }
        .char-punctuation.quote-open {
            top: 3px;
            right: 3px;
            font-size: 14px;
        }
        .char-punctuation.quote-close {
            top: 3px;
            left: 3px;
            font-size: 14px;
        }
        .char-count {
            margin-top: 15px;
            padding: 10px;
            background-color: #3d3d3d;
            border-radius: 5px;
            font-weight: bold;
            color: #ffffff;
            text-align: center;
            font-size: 16px;
            margin-bottom: 0;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
        }
        .modal.show {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #2d2d2d;
            padding: 30px;
            border-radius: 10px;
            border: 2px solid #4CAF50;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-content h2 {
            color: #ffffff;
            margin-bottom: 20px;
            text-align: center;
        }
        .modal-content input {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            background-color: #3d3d3d;
            border: 1px solid #555;
            border-radius: 5px;
            color: #ffffff;
            font-size: 16px;
        }
        .modal-content .btn-group {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        .modal-content button {
            padding: 10px 25px;
            border: none;
            border-radius: 5px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
        }
        .modal-content .confirm-btn {
            background-color: #4CAF50;
            color: white;
        }
        .modal-content .confirm-btn:hover {
            background-color: #45a049;
        }
        .modal-content .cancel-btn {
            background-color: #EF4444;
            color: white;
        }
        .modal-content .cancel-btn:hover {
            background-color: #DC2626;
        }
        .saved-list {
            list-style: none;
            padding: 0;
            margin: 20px 0;
        }
        .saved-list li {
            padding: 15px;
            margin-bottom: 10px;
            background-color: #3d3d3d;
            border-radius: 5px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .saved-list li:hover {
            border-color: #4CAF50;
            background-color: #4a4a4a;
        }
        .saved-list li .title {
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 5px;
        }
        .saved-list li .info {
            font-size: 12px;
            color: #aaa;
        }
        .input-box {
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            background: #3d3d3d;
            border: 2px solid #4CAF50;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.7);
            z-index: 1000;
            transition: top 0.2s ease;
            display: flex;
            align-items: center;
        }
        .prev-content {
            margin-right: 10px;
            font-size: 18px;
            color: #ffffff;
            width: 40px;
            height: 40px;
            border: 1px solid #555;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #2d2d2d;
            position: relative;
        }
        .input-box input {
            width: 120px;
            padding: 10px;
            font-size: 18px;
            border: 1px solid #555;
            border-radius: 3px;
            font-family: 'Malgun Gothic', sans-serif;
            text-align: center;
            background-color: #2d2d2d;
            color: #ffffff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>한국어 원고지</h1>
        <div class="setup-area">
            <label for="classSelect">반:</label>
            <select id="classSelect">
                <option value="3A">3A</option>
                <option value="3B">3B</option>
                <option value="4A">4A</option>
                <option value="4B">4B</option>
            </select>
            <label for="studentName">학생 이름:</label>
            <input type="text" id="studentName" placeholder="이름을 입력하세요">
            <label for="colsSelect">칸 수:</label>
            <select id="colsSelect">
                <option value="20">20칸 (400자)</option>
                <option value="25-300">25칸 (300자)</option>
                <option value="25-700">25칸 (700자)</option>
            </select>
            <button id="startBtn">시작</button>
        </div>
        <div class="info" id="infoArea">
            원고지 작성 규칙<br>
            대기 시스템: 숫자, 마침표/쉼표, 영어소문자는 다음 글자를 기다림<br>
            화살표 키로 칸 이동, 백스페이스로 삭제
        </div>
        <div id="workArea" class="work-area">
            <div id="manuscriptPaper" class="manuscript-paper cols-20"></div>
            <div class="char-count">글자 수: <span id="charCount">0</span> | 학생: <span id="currentStudent"></span></div>
            <div class="action-buttons">
                <button class="supabase-save-btn" onclick="saveToSupabase()">서버에 저장</button>
                <button class="supabase-load-btn" onclick="loadFromSupabase()">서버에서 불러오기</button>
                <button class="copy-btn" onclick="copyToClipboard()">텍스트 복사</button>
                <button class="logout-btn" onclick="logout()">로그아웃</button>
            </div>
            <div class="input-box">
                <span id="prevContent" class="prev-content"></span>
                <input type="text" id="inputBox" placeholder="">
            </div>
        </div>
    </div>
    
    <div id="saveModal" class="modal">
        <div class="modal-content">
            <h2>원고 저장</h2>
            <input type="text" id="saveTitle" placeholder="제목을 입력하세요 (예: 첫번째 작문)">
            <div class="btn-group">
                <button class="confirm-btn" onclick="confirmSave()">저장</button>
                <button class="cancel-btn" onclick="closeSaveModal()">취소</button>
            </div>
        </div>
    </div>
    
    <div id="loadModal" class="modal">
        <div class="modal-content">
            <h2>저장된 원고 목록</h2>
            <ul id="savedList" class="saved-list"></ul>
            <div class="btn-group">
                <button class="cancel-btn" onclick="closeLoadModal()">닫기</button>
            </div>
        </div>
    </div>
    
    <script>
        const SUPABASE_URL = 'https://svlqqkfkmevcjssarpng.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN2bHFxa2ZrbWV2Y2pzc2FycG5nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA4NjE5MDUsImV4cCI6MjA2NjQzNzkwNX0.bB8oanmqsBtoL3H4xwczP6khaojvnu02VWmtm0xY_yM';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        var cols=20,rows=20,allCells=[],cellData=[],currentPos=0,isComposing=false;
        var waitingChar='';
        var currentStudentName = '';
        var currentClass = '3A';
        var paperType = '20';
        
        var studentNameInput=document.getElementById('studentName');
        var colsSelect=document.getElementById('colsSelect');
        var classSelect=document.getElementById('classSelect');
        var startBtn=document.getElementById('startBtn');
        var workArea=document.getElementById('workArea');
        var infoArea=document.getElementById('infoArea');
        var manuscriptPaper=document.getElementById('manuscriptPaper');
        var inputBox=document.getElementById('inputBox');
        var prevContent=document.getElementById('prevContent');
        var charCount=document.getElementById('charCount');
        var currentStudentDisplay=document.getElementById('currentStudent');

        function setCookie(name, value, days) {
            var expires = "";
            if (days) {
                var date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                expires = "; expires=" + date.toUTCString();
            }
            document.cookie = name + "=" + (value || "") + expires + "; path=/";
        }
        
        function getCookie(name) {
            var nameEQ = name + "=";
            var ca = document.cookie.split(';');
            for (var i = 0; i < ca.length; i++) {
                var c = ca[i];
                while (c.charAt(0) == ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }
        
        function eraseCookie(name) {
            document.cookie = name + '=; Max-Age=-99999999; path=/';
        }

        window.addEventListener('load', function() {
            var savedName = getCookie('studentName');
            var savedClass = getCookie('studentClass');
            
            if (savedName) {
                studentNameInput.value = savedName;
            }
            if (savedClass) {
                classSelect.value = savedClass;
            }
        });

        startBtn.addEventListener('click',async function(){
            var studentName = studentNameInput.value.trim();
            if(!studentName){
                alert('이름을 입력해주세요.');
                return;
            }
            
            const { data, error } = await supabase
                .from('id_students')
                .select('student_name')
                .eq('student_name', studentName)
                .single();
            
            if(error || !data){
                alert('등록되지 않은 학생입니다.\n선생님께 문의해주세요.');
                return;
            }
            
            currentStudentName = studentName;
            currentClass = classSelect.value;
            currentStudentDisplay.textContent = studentName;
            
            setCookie('studentName', studentName, 30);
            setCookie('studentClass', currentClass, 30);
            
            paperType = colsSelect.value;
            
            if(paperType === '20'){
                cols = 20;
                rows = 20;
            } else if(paperType === '25-300'){
                cols = 25;
                rows = 12;
            } else if(paperType === '25-700'){
                cols = 25;
                rows = 28;
            }
            
            initializePaper();
            workArea.classList.add('show');
            infoArea.classList.add('hide');
            setTimeout(function(){updateInputBoxPosition();inputBox.focus();},100);
        });

        function initializePaper(){
            manuscriptPaper.className='manuscript-paper cols-'+cols;
            manuscriptPaper.innerHTML='';
            allCells=[];cellData=[];currentPos=0;waitingChar='';
            var totalCells=cols*rows;
            for(var i=0;i<totalCells;i++){
                var cell=document.createElement('div');
                cell.className='cell';
                cell.dataset.index=i;
                if(i===0)cell.classList.add('first-cell');
                if((i+1)%cols===0)cell.classList.add('last-cell');
                if((i+1)%100===0)cell.classList.add('hundred-mark');
                var content=document.createElement('div');
                content.className='cell-content';
                cell.appendChild(content);
                cell.addEventListener('click',function(e){
                    var idx=parseInt(e.currentTarget.dataset.index);
                    currentPos=idx;updateActiveCell();inputBox.focus();
                });
                manuscriptPaper.appendChild(cell);
                allCells.push(cell);cellData.push('');
            }
            updateActiveCell();
        }

        function updateActiveCell(){
            for(var i=0;i<allCells.length;i++)allCells[i].classList.remove('active');
            clearPreview();
            if(currentPos>=0&&currentPos<allCells.length){
                allCells[currentPos].classList.add('active');
                allCells[currentPos].scrollIntoView({behavior:'smooth',block:'center',inline:'center'});
                setTimeout(updateInputBoxPosition,300);
                updatePrevContent();
            }
        }

        function clearPreview(){
            var previews = document.querySelectorAll('.preview-text, .preview-two-chars');
            previews.forEach(function(preview){
                preview.remove();
            });
        }

        function showPreview(text){
            if(currentPos<0||currentPos>=allCells.length)return;
            if(!text)return;
            
            clearPreview();
            
            var content=allCells[currentPos].querySelector('.cell-content');
            
            if(text.length===2){
                var span=document.createElement('span');
                span.className='preview-two-chars';
                var char1=document.createElement('span');
                char1.textContent=text.charAt(0);
                var char2=document.createElement('span');
                char2.textContent=text.charAt(1);
                span.appendChild(char1);
                span.appendChild(char2);
                content.appendChild(span);
            }else if(text.length===1){
                var span=document.createElement('span');
                span.className='preview-text';
                span.textContent=text;
                content.appendChild(span);
            }
        }

        function updatePrevContent(){
            prevContent.innerHTML='';
            if(currentPos>0){
                var index=currentPos-1;
                var data=cellData[index];
                if(data){
                    if(data.length===2){
                        var span=document.createElement('span');
                        span.className='two-chars';
                        var char1=document.createElement('span');
                        char1.textContent=data.charAt(0);
                        var char2=document.createElement('span');
                        char2.textContent=data.charAt(1);
                        span.appendChild(char1);
                        span.appendChild(char2);
                        prevContent.appendChild(span);
                    }else{
                        var span=document.createElement('span');
                        var isPunc=(data==='.'||data===',');
                        span.className=isPunc?'char-punctuation-single':'char-main';
                        span.textContent=data;
                        prevContent.appendChild(span);
                    }
                }
            }
        }

        function updateInputBoxPosition(){
            if(currentPos<0||currentPos>=allCells.length)return;
            var activeCell=allCells[currentPos];
            var rect=activeCell.getBoundingClientRect();
            var inputBoxElement=document.querySelector('.input-box');
            var inputBoxHeight=inputBoxElement.offsetHeight;
            var topPosition=rect.bottom+50;
            if(topPosition+inputBoxHeight>window.innerHeight)topPosition=rect.top-inputBoxHeight-10;
            if(topPosition<0)topPosition=rect.bottom+50;
            topPosition=Math.max(0,Math.min(window.innerHeight-inputBoxHeight,topPosition));
            inputBoxElement.style.top=topPosition+'px';
        }

        function isKorean(c){var code=c.charCodeAt(0);return(code>=0xAC00&&code<=0xD7A3)||(code>=0x1100&&code<=0x11FF)||(code>=0x3130&&code<=0x318F);}
        function isEnglishUpper(c){return/[A-Z]/.test(c);}
        function isEnglishLower(c){return/[a-z]/.test(c);}
        function isNumber(c){return/[0-9]/.test(c);}
        function isQuote(c){return c==='"'||c==="'"||c==='\u201C'||c==='\u201D'||c==='\u2018'||c==='\u2019';}
        function isOpenQuote(c){return c==='"'||c==='\u201C'||c==='\u2018';}
        function isCloseQuote(c){return c==='"'||c==='\u201D'||c==='\u2019';}
        function isPunctuation(c){return c==='.'||c===',';}
        function isLastInRow(pos){return(pos+1)%cols===0;}

        function renderCell(index){
            if(index<0||index>=allCells.length)return;
            var content=allCells[index].querySelector('.cell-content');
            content.innerHTML='';
            var data=cellData[index];
            if(!data)return;
            if(data.length===2){
                var span=document.createElement('span');
                span.className='two-chars';
                var char1=document.createElement('span');
                char1.textContent=data.charAt(0);
                var char2=document.createElement('span');
                char2.textContent=data.charAt(1);
                span.appendChild(char1);
                span.appendChild(char2);
                content.appendChild(span);
            }else{
                var span=document.createElement('span');
                var isPunc=(data==='.'||data===',');
                span.className=isPunc?'char-punctuation-single':'char-main';
                span.textContent=data;
                content.appendChild(span);
            }
        }

        function writeCell(text){
            if(currentPos>=allCells.length)return;
            cellData[currentPos]=text;
            renderCell(currentPos);
            if(currentPos<allCells.length-1){
                currentPos++;
                updateActiveCell();
            }
            updateCharCount();
        }

        function updateCharCount(){
            var count=0;
            for(var i=0;i<cellData.length;i++){if(cellData[i])count++;}
            charCount.textContent=count;
        }

        function processChar(newChar){
            if(waitingChar){
                var prev=waitingChar;
                var prevPos = currentPos;
                waitingChar='';
                
                if(isNumber(prev)){
                    if(isPunctuation(newChar)||isNumber(newChar)){
                        cellData[currentPos]=prev+newChar;
                        renderCell(currentPos);
                        if(currentPos<allCells.length-1){
                            currentPos++;
                            updateActiveCell();
                        }
                        updateCharCount();
                        inputBox.value='';
                        return;
                    }
                    cellData[currentPos]=prev;
                    renderCell(currentPos);
                    if(currentPos<allCells.length-1){
                        currentPos++;
                        updateActiveCell();
                    }
                    updateCharCount();
                    if(isNumber(newChar)||isPunctuation(newChar)||isEnglishLower(newChar)){
                        waitingChar=newChar;
                        inputBox.value=newChar;
                    }else{
                        if(isKorean(newChar)&&isLastInRow(currentPos)){
                            waitingChar=newChar;
                            inputBox.value=newChar;
                        }else{
                            cellData[currentPos]=newChar;
                            renderCell(currentPos);
                            if(currentPos<allCells.length-1){
                                currentPos++;
                                updateActiveCell();
                            }
                            updateCharCount();
                            inputBox.value='';
                        }
                    }
                    return;
                }
                
                if(isPunctuation(prev)){
                    if(isNumber(newChar)||isQuote(newChar)){
                        cellData[currentPos]=prev+newChar;
                        renderCell(currentPos);
                        if(currentPos<allCells.length-1){
                            currentPos++;
                            updateActiveCell();
                        }
                        updateCharCount();
                        inputBox.value='';
                        return;
                    }
                    cellData[currentPos]=prev;
                    renderCell(currentPos);
                    if(currentPos<allCells.length-1){
                        currentPos++;
                        updateActiveCell();
                    }
                    updateCharCount();
                    if(isNumber(newChar)||isPunctuation(newChar)||isEnglishLower(newChar)){
                        waitingChar=newChar;
                        inputBox.value=newChar;
                    }else{
                        if(isKorean(newChar)&&isLastInRow(currentPos)){
                            waitingChar=newChar;
                            inputBox.value=newChar;
                        }else{
                            cellData[currentPos]=newChar;
                            renderCell(currentPos);
                            if(currentPos<allCells.length-1){
                                currentPos++;
                                updateActiveCell();
                            }
                            updateCharCount();
                            inputBox.value='';
                        }
                    }
                    return;
                }
                
                if(isEnglishLower(prev)){
                    if(isLastInRow(prevPos)&&newChar==='-'){
                        cellData[currentPos]=prev+'-';
                        renderCell(currentPos);
                        if(currentPos<allCells.length-1){
                            currentPos++;
                            updateActiveCell();
                        }
                        updateCharCount();
                        inputBox.value='';
                        return;
                    }
                    if(isEnglishLower(newChar)){
                        cellData[currentPos]=prev+newChar;
                        renderCell(currentPos);
                        if(currentPos<allCells.length-1){
                            currentPos++;
                            updateActiveCell();
                        }
                        updateCharCount();
                        inputBox.value='';
                        return;
                    }
                    cellData[currentPos]=prev;
                    renderCell(currentPos);
                    if(currentPos<allCells.length-1){
                        currentPos++;
                        updateActiveCell();
                    }
                    updateCharCount();
                    if(isNumber(newChar)||isPunctuation(newChar)||isEnglishLower(newChar)){
                        waitingChar=newChar;
                        inputBox.value=newChar;
                    }else{
                        if(isKorean(newChar)&&isLastInRow(currentPos)){
                            waitingChar=newChar;
                            inputBox.value=newChar;
                        }else{
                            cellData[currentPos]=newChar;
                            renderCell(currentPos);
                            if(currentPos<allCells.length-1){
                                currentPos++;
                                updateActiveCell();
                            }
                            updateCharCount();
                            inputBox.value='';
                        }
                    }
                    return;
                }
                
                if(isKorean(prev)){
                    if(isPunctuation(newChar)){
                        cellData[currentPos]=prev+newChar;
                        renderCell(currentPos);
                        if(currentPos<allCells.length-1){
                            currentPos++;
                            updateActiveCell();
                        }
                        updateCharCount();
                        inputBox.value='';
                        return;
                    }
                    cellData[currentPos]=prev;
                    renderCell(currentPos);
                    if(currentPos<allCells.length-1){
                        currentPos++;
                        updateActiveCell();
                    }
                    updateCharCount();
                    if(isNumber(newChar)||isPunctuation(newChar)||isEnglishLower(newChar)){
                        waitingChar=newChar;
                        inputBox.value=newChar;
                    }else{
                        if(isKorean(newChar)&&isLastInRow(currentPos)){
                            waitingChar=newChar;
                            inputBox.value=newChar;
                        }else{
                            cellData[currentPos]=newChar;
                            renderCell(currentPos);
                            if(currentPos<allCells.length-1){
                                currentPos++;
                                updateActiveCell();
                            }
                            updateCharCount();
                            inputBox.value='';
                        }
                    }
                    return;
                }
            }
            
            if(newChar===' '||newChar==='\n'){
                if(currentPos<allCells.length-1){
                    currentPos++;
                    updateActiveCell();
                }
                inputBox.value='';
                return;
            }
            
            if(isNumber(newChar)||isPunctuation(newChar)||isEnglishLower(newChar)){
                waitingChar=newChar;
                inputBox.value=newChar;
                return;
            }
            
            if(isKorean(newChar)&&isLastInRow(currentPos)){
                waitingChar=newChar;
                inputBox.value=newChar;
                return;
            }
            
            writeCell(newChar);
            inputBox.value='';
        }

        inputBox.addEventListener('compositionstart',function(){
            isComposing=true;
            clearPreview();
        });

        inputBox.addEventListener('compositionupdate',function(e){
            if(e.data){
                if(waitingChar){
                    var combinedText = waitingChar + e.data;
                    showPreview(combinedText);
                }else{
                    showPreview(e.data);
                }
            }
        });

        inputBox.addEventListener('compositionend',function(e){
            isComposing=false;
            clearPreview();
            if(e.data){
                processChar(e.data);
            }
        });

        inputBox.addEventListener('input',function(e){
            if(isComposing)return;
            var value=e.target.value;
            
            if(value.length>0){
                if(waitingChar){
                    var combinedText = waitingChar + value.charAt(value.length-1);
                    if(combinedText.length===2){
                        showPreview(combinedText);
                    }else{
                        showPreview(value.charAt(value.length-1));
                    }
                }else{
                    showPreview(value);
                }
            }else{
                clearPreview();
            }
            
            if(value.length>0){
                var newChar=value.charAt(value.length-1);
                processChar(newChar);
            }
        });

        inputBox.addEventListener('keydown',function(e){
            if(e.key==='Backspace'){
                if(inputBox.value===''){
                    e.preventDefault();
                    clearPreview();
                    if(cellData[currentPos]){
                        cellData[currentPos]='';
                        renderCell(currentPos);
                        updateCharCount();
                    }else if(currentPos>0){
                        currentPos--;
                        cellData[currentPos]='';
                        renderCell(currentPos);
                        updateActiveCell();
                        updateCharCount();
                    }
                    waitingChar='';
                }else{
                    waitingChar='';
                    clearPreview();
                }
            }else if(e.key==='Delete'){
                e.preventDefault();
                clearPreview();
                cellData[currentPos]='';
                renderCell(currentPos);
                updateCharCount();
                waitingChar='';
                inputBox.value='';
            }else if(e.key==='Enter'){
                e.preventDefault();
                clearPreview();
                if(waitingChar){
                    cellData[currentPos]=waitingChar;
                    renderCell(currentPos);
                    if(currentPos<allCells.length-1){
                        currentPos++;
                        updateActiveCell();
                    }
                    updateCharCount();
                    waitingChar='';
                    inputBox.value='';
                }else if(currentPos<allCells.length-1){
                    currentPos++;
                    updateActiveCell();
                }
            }else if(e.key===' '){
                e.preventDefault();
                clearPreview();
                if(waitingChar){
                    cellData[currentPos]=waitingChar;
                    renderCell(currentPos);
                    if(currentPos<allCells.length-1){
                        currentPos++;
                        updateActiveCell();
                    }
                    updateCharCount();
                    waitingChar='';
                    inputBox.value='';
                }
                if(currentPos<allCells.length-1){
                    currentPos++;
                    updateActiveCell();
                }
            }else if(e.key==='ArrowLeft'){
                e.preventDefault();
                clearPreview();
                if(waitingChar){
                    cellData[currentPos]=waitingChar;
                    renderCell(currentPos);
                    if(currentPos<allCells.length-1){
                        currentPos++;
                        updateActiveCell();
                    }
                    updateCharCount();
                    waitingChar='';
                    inputBox.value='';
                }
                if(currentPos>0){
                    currentPos--;
                    updateActiveCell();
                }
            }else if(e.key==='ArrowRight'){
                e.preventDefault();
                clearPreview();
                if(waitingChar){
                    cellData[currentPos]=waitingChar;
                    renderCell(currentPos);
                    if(currentPos<allCells.length-1){
                        currentPos++;
                        updateActiveCell();
                    }
                    updateCharCount();
                    waitingChar='';
                    inputBox.value='';
                }
                if(currentPos<allCells.length-1){
                    currentPos++;
                    updateActiveCell();
                }
            }else if(e.key==='ArrowUp'){
                e.preventDefault();
                clearPreview();
                if(waitingChar){
                    cellData[currentPos]=waitingChar;
                    renderCell(currentPos);
                    if(currentPos<allCells.length-1){
                        currentPos++;
                        updateActiveCell();
                    }
                    updateCharCount();
                    waitingChar='';
                    inputBox.value='';
                }
                if(currentPos>=cols){
                    currentPos-=cols;
                    updateActiveCell();
                }
            }else if(e.key==='ArrowDown'){
                e.preventDefault();
                clearPreview();
                if(waitingChar){
                    cellData[currentPos]=waitingChar;
                    renderCell(currentPos);
                    if(currentPos<allCells.length-1){
                        currentPos++;
                        updateActiveCell();
                    }
                    updateCharCount();
                    waitingChar='';
                    inputBox.value='';
                }
                if(currentPos<allCells.length-cols){
                    currentPos+=cols;
                    updateActiveCell();
                }
            }
        });

        manuscriptPaper.addEventListener('click',function(){inputBox.focus();});
        window.addEventListener('resize',function(){if(currentPos>=0&&currentPos<allCells.length){updateInputBoxPosition();}});
        window.addEventListener('scroll',function(){if(currentPos>=0&&currentPos<allCells.length){updateInputBoxPosition();}});

        function logout(){
            if(confirm('로그아웃 하시겠습니까?\n저장하지 않은 내용은 사라집니다.')){
                currentStudentName = '';
                currentClass = '3A';
                studentNameInput.value = '';
                
                eraseCookie('studentName');
                eraseCookie('studentClass');
                
                workArea.classList.remove('show');
                infoArea.classList.remove('hide');
                
                for(var i=0; i<cellData.length; i++){
                    cellData[i] = '';
                    renderCell(i);
                }
                currentPos = 0;
                waitingChar = '';
                updateCharCount();
            }
        }

        function copyToClipboard(){
            var text = getManuscriptText();
            navigator.clipboard.writeText(text).then(function(){
                alert('텍스트가 클립보드에 복사되었습니다!');
            }).catch(function(err){
                alert('복사 실패: ' + err);
            });
        }

        function getManuscriptText(){
            var lines = [];
            for(var row=0; row<rows; row++){
                var rowCells = [];
                for(var col=0; col<cols; col++){
                    var index = row * cols + col;
                    rowCells.push(cellData[index] || '');
                }
                lines.push(rowCells.join('\t'));
            }
            return lines.join('\n');
        }

        function loadManuscriptText(text, savedCols){
            // 먼저 모든 셀 초기화
            for(var i=0; i<cellData.length; i++){
                cellData[i] = '';
            }
            
            // 줄 단위로 분리
            var lines = text.split('\n');
            
            // 저장된 칸 수 자동 감지 (첫 줄의 탭 개수로 판단)
            if(lines.length > 0 && !savedCols){
                var firstLineCells = lines[0].split('\t');
                savedCols = firstLineCells.length;
            }
            
            // 칸 수 호환성 체크
            if(savedCols && savedCols !== cols){
                // 20칸과 25칸은 완전히 별개
                if((savedCols === 20 && cols === 25) || (savedCols === 25 && cols === 20)){
                    alert('저장된 원고(' + savedCols + '칸)와 현재 용지(' + cols + '칸)의 칸 수가 다릅니다.\n자동으로 용지 크기를 변경합니다.');
                    
                    if(savedCols === 20){
                        paperType = '20';
                        cols = 20;
                        rows = 20;
                    } else if(savedCols === 25){
                        // 실제 줄 수로 300자/700자 판단
                        var contentRows = 0;
                        for(var k=0; k<lines.length; k++){
                            var cells = lines[k].split('\t');
                            for(var j=0; j<cells.length; j++){
                                if(cells[j]){
                                    contentRows = k + 1;
                                    break;
                                }
                            }
                        }
                        
                        if(contentRows <= 12){
                            paperType = '25-300';
                            cols = 25;
                            rows = 12;
                        } else {
                            paperType = '25-700';
                            cols = 25;
                            rows = 28;
                        }
                    }
                    
                    colsSelect.value = paperType;
                    initializePaper();
                } else if(cols === 25 && savedCols === 25){
                    // 25칸 내에서 300자/700자 변경
                    if(lines.length > rows){
                        alert('저장된 줄 수가 현재 용지보다 많습니다.\n자동으로 용지 크기를 변경합니다.');
                        paperType = '25-700';
                        cols = 25;
                        rows = 28;
                        colsSelect.value = paperType;
                        initializePaper();
                    }
                }
            }
            
            // 데이터 로드 - 줄과 칸의 정확한 위치 복원
            for(var lineIdx=0; lineIdx<lines.length && lineIdx<rows; lineIdx++){
                var cells = lines[lineIdx].split('\t');
                for(var cellIdx=0; cellIdx<cells.length && cellIdx<cols; cellIdx++){
                    var index = lineIdx * cols + cellIdx;
                    if(cells[cellIdx]){
                        cellData[index] = cells[cellIdx];
                        renderCell(index);
                    }
                }
            }
            
            currentPos = 0;
            waitingChar = '';
            updateActiveCell();
            updateCharCount();
            inputBox.value = '';
            inputBox.focus();
        }
        
        async function saveToSupabase(){
            if(!currentStudentName){
                alert('학생 이름이 확인되지 않았습니다.');
                return;
            }
            
            var text = getManuscriptText();
            if(!text.trim()){
                alert('저장할 내용이 없습니다.');
                return;
            }
            
            document.getElementById('saveModal').classList.add('show');
            document.getElementById('saveTitle').value = '';
            document.getElementById('saveTitle').focus();
        }
        
        function closeSaveModal(){
            document.getElementById('saveModal').classList.remove('show');
        }
        
        async function confirmSave(){
            var title = document.getElementById('saveTitle').value.trim();
            if(!title){
                alert('제목을 입력해주세요.');
                return;
            }
            
            var text = getManuscriptText();
            
            const { data: existingData, error: selectError } = await supabase
                .from('wongo')
                .select('id')
                .eq('student_name', currentStudentName)
                .eq('class', currentClass)
                .eq('title', title)
                .maybeSingle();
            
            if(selectError){
                alert('저장 실패: ' + selectError.message);
                return;
            }
            
            if(existingData){
                if(!confirm('같은 제목의 원고가 있습니다.\n덮어쓰시겠습니까?')){
                    return;
                }
                
                const { error } = await supabase
                    .from('wongo')
                    .update({
                        content: text,
                        cols: cols,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', existingData.id);
                
                if(error){
                    alert('저장 실패: ' + error.message);
                }else{
                    alert('원고가 업데이트되었습니다!');
                    closeSaveModal();
                }
            }else{
                const { error } = await supabase
                    .from('wongo')
                    .insert({
                        student_name: currentStudentName,
                        class: currentClass,
                        title: title,
                        content: text,
                        cols: cols
                    });
                
                if(error){
                    alert('저장 실패: ' + error.message);
                }else{
                    alert('새 원고가 저장되었습니다!');
                    closeSaveModal();
                }
            }
        }
        
        async function loadFromSupabase(){
            if(!currentStudentName){
                alert('학생 이름이 확인되지 않았습니다.');
                return;
            }
            
            const { data, error } = await supabase
                .from('wongo')
                .select('id, title, content, modified_text, cols, created_at, updated_at')
                .eq('student_name', currentStudentName)
                .eq('class', currentClass)
                .order('updated_at', { ascending: false });
            
            if(error || !data || data.length === 0){
                alert('저장된 원고가 없습니다.');
                return;
            }
            
            var listHTML = '';
            data.forEach(function(item, index){
                var hasModified = item.modified_text ? ' (선생님 수정본)' : '';
                var date = new Date(item.updated_at || item.created_at);
                var dateStr = date.toLocaleDateString('ko-KR') + ' ' + date.toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit'});
                
                var paperInfo = '';
                var charCount = item.content ? item.content.length : 0;
                if(item.cols === 20) paperInfo = '20칸 (' + charCount + '자)';
                else if(item.cols === 25) paperInfo = '25칸 (' + charCount + '자)';
                else paperInfo = item.cols + '칸 (' + charCount + '자)';
                
                listHTML += '<li onclick="loadSelectedManuscript(' + index + ')">';
                listHTML += '<div class="title">' + (item.title || '제목 없음') + hasModified + '</div>';
                listHTML += '<div class="info">' + dateStr + ' | ' + paperInfo + '</div>';
                listHTML += '</li>';
            });
            
            document.getElementById('savedList').innerHTML = listHTML;
            document.getElementById('loadModal').classList.add('show');
            
            window.savedManuscripts = data;
        }
        
        function closeLoadModal(){
            document.getElementById('loadModal').classList.remove('show');
        }
        
        function loadSelectedManuscript(index){
            var item = window.savedManuscripts[index];
            
            var textToLoad = item.modified_text || item.content;
            
            if(!textToLoad){
                alert('저장된 내용이 없습니다.');
                return;
            }
            
            var savedCols = item.cols || 20;
            
            loadManuscriptText(textToLoad, savedCols);
            
            closeLoadModal();
            
            if(item.modified_text){
                alert('선생님이 수정한 원고를 불러왔습니다.');
            }else{
                alert('원고를 불러왔습니다.');
            }
        }
    </script>
</body>
</html>