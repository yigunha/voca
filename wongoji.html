<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì›ê³ ì§€ - í•™ìƒìš© (WASM)</title>
    <link rel="stylesheet" href="./wongoji/teacher_style.css">
    <style>
        body { opacity: 0; transition: opacity 0.5s; }
        body.loaded { opacity: 1; }
        .login-area h1 { color: #2196F3; } 
        .login-btn { background-color: #2196F3; }
        .login-btn:hover { background-color: #1976D2; }
        .header h1 { color: #2196F3; }
        .header { border-bottom-color: #2196F3; }
        
        .cell.selected { background-color: transparent !important; border: 2px solid #2196F3 !important; z-index: 10 !important; }
        .cell.active { background-color: transparent !important; border: 2px solid #4CAF50 !important; z-index: 20 !important; }
        
        .undo-btn, .redo-btn { background-color: #607d8b; color: white; margin-right: 5px; }
        .undo-btn:hover, .redo-btn:hover { background-color: #546e7a; }

        .create-section { display: flex; gap: 10px; align-items: center; margin-left: auto; }
        .create-input { padding: 8px; border: 1px solid #555; border-radius: 5px; background: #2d2d2d; color: white; }
        .create-select { padding: 8px; border: 1px solid #555; border-radius: 5px; background: #2d2d2d; color: white; }
        .create-btn { padding: 8px 15px; background-color: #2196F3; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .create-btn:hover { background-color: #1976D2; }
    </style>
</head>
<body>
    <div class="container">
        <div class="login-area" id="loginArea">
            <h1>ğŸ£ í•™ìƒ ë¡œê·¸ì¸</h1>
            <div class="login-form">
                <label for="studentClass">ë°˜ ì„ íƒ:</label>
                <select id="studentClass">
                    <option value="1A">1A</option><option value="1B">1B</option>
                    <option value="2A">2A</option><option value="2B">2B</option>
                    <option value="3A">3A</option><option value="3B">3B</option>
                    <option value="4A">4A</option><option value="4B">4B</option>
                </select>
                <label for="studentName">ì´ë¦„:</label>
                <input type="text" id="studentName" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
                <label for="studentPassword">ë¹„ë°€ë²ˆí˜¸ (í•™ë²ˆ ë’¤ 4ìë¦¬):</label>
                <input type="password" id="studentPassword" placeholder="1234">
                <button id="loginBtn" class="login-btn">ë¡œê·¸ì¸</button>
            </div>
        </div>

        <div class="teacher-area" id="studentArea" style="display:none;">
            <div class="header">
                <h1>ğŸ“ ë‚´ ì›ê³  ë³´ê´€í•¨</h1>
                <div class="teacher-info">
                    <span id="currentStudentInfo"></span>
                    <button id="logoutBtn" class="logout-logout_student">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
            </div>
            
            <div class="filter-section">
                <button id="refreshBtn" class="refresh-btn">ìƒˆë¡œê³ ì¹¨</button>
                <div class="create-section">
                    <input type="text" id="newTitle" class="create-input" placeholder="ìƒˆ ì›ê³  ì œëª©">
                    <select id="newCols" class="create-select">
                        <option value="20_400">20ì¹¸ (400ì)</option>
                        <option value="25_300">25ì¹¸ (300ì)</option>
                        <option value="25_700">25ì¹¸ (700ì)</option>
                    </select>
                    <button id="createBtn" class="create-btn">ì›ê³  ìƒì„±</button>
                </div>
            </div>

            <div class="manuscripts-section">
                <h2>ë‚´ê°€ ì“´ ì›ê³ </h2>
                <div id="manuscriptsList" class="manuscripts-list"></div>
            </div>
            
            <div id="editModal" class="modal">
                <div class="modal-content-large">
                    <div class="modal-header">
                        <h2 id="editTitle">ì›ê³  ì“°ê¸°</h2>
                        <button id="closeModalBtn" class="close-btn">âœ•</button>
                    </div>
                    <div class="layer-switch">
                        <div class="layer-button-container">
                            <button id="layerToggleBtn" class="layer-toggle-btn student-active">í•™ìƒëª¨ë“œ ( Tab )</button>
                            <label class="empty-row-label">
                                <input type="checkbox" id="hideEmptyRowsCheck" class="empty-row-checkbox">
                                <span class="empty-row-text">ë¹ˆ ì¤„<br>ìˆ¨ê¸°ê¸°</span>
                            </label>
                        </div>
                    </div>
                    <div class="manuscript-memo-container">
                        <div class="manuscript-center">
                            <div class="manuscript-wrapper">
                                <div class="error-line-container">
                                    <svg id="errorLineSvg" class="error-line-svg"></svg>
                                </div>
                                <div id="manuscriptPaper" class="manuscript-paper"></div>
                            </div>
                        </div>
                    </div>
                    <div class="edit-controls">
                        <button id="undoBtn" class="undo-btn">â†©ï¸ ì‹¤í–‰ì·¨ì†Œ</button>
                        <button id="redoBtn" class="redo-btn">â†ªï¸ ë‹¤ì‹œì‹¤í–‰</button>
                        <span style="width: 20px;"></span>
                        <button id="saveBtn" class="save-btn">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
                        <button id="closeBtnBottom" class="cancel-btn">ë‹«ê¸°</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import init, { 
            init_app, login_student, logout_student, fetch_my_manuscripts, save_student_content, create_new_manuscript,
            render_paper_rs, switch_layer_rs, fill_grid_content, read_grid_content, load_full_data_rs,
            draw_markings_rs, clear_markings_rs, init_input_state, set_cursor_pos,
            handle_composition_start, handle_composition_update, handle_composition_end,
            handle_input_event, handle_keydown, force_stop_composition, toggle_empty_rows_rs,
            handle_cell_mousedown, handle_cell_mouseenter, handle_global_mouseup,
            get_selected_text, paste_text_at_cursor, delete_selected_cells,
            undo, redo, get_cookie
        } from './wongoji/pkg/wongoji.js';

        let currentCols = 20;
        let currentRows = 20;
        let currentManuscriptId = null;
        let currentErrorText = "[]";
        let currentLayer = "student";
        let hasUnsavedChanges = false;
        let originalContent = "";

        async function run() {
            try {
                await init();
                init_app();
                document.body.classList.add('loaded');
                checkLogin();
                setupEventListeners();
            } catch (e) {
                alert("WASM ì´ˆê¸°í™” ì‹¤íŒ¨: " + e);
            }
        }

        run();

        function checkLogin() {
            try {
                const name = get_cookie("studentName");
                const cls = get_cookie("studentClass");
                if (name && cls) showStudentArea(name, cls);
                else showLoginArea();
            } catch (e) { showLoginArea(); }
        }

        function showStudentArea(name, cls) {
            document.getElementById('loginArea').style.display = 'none';
            document.getElementById('studentArea').style.display = 'block';
            document.getElementById('currentStudentInfo').textContent = `${decodeURIComponent(cls)} ${decodeURIComponent(name)}`;
            loadData();
        }

        function showLoginArea() {
            document.getElementById('loginArea').style.display = 'block';
            document.getElementById('studentArea').style.display = 'none';
        }

        async function loadData() {
            try {
                const data = await fetch_my_manuscripts();
                renderManuscriptList(data);
                return data; 
            } catch (err) { alert(err); return []; }
        }

        function renderManuscriptList(data) {
            const list = document.getElementById('manuscriptsList');
            list.innerHTML = '';
            if (data.length === 0) {
                list.innerHTML = '<p style="padding:20px; text-align:center;">ì‘ì„±ëœ ì›ê³ ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            data.forEach(item => {
                const div = document.createElement('div');
                div.className = 'manuscript-card';
                let typeStr = item.cols + "ì¹¸ ì›ê³ ì§€";
                div.innerHTML = `
                    <div class="card-header"><div class="class-badge">${item.class}</div></div>
                    <div class="title">${item.title}</div>
                    <div class="info">${typeStr} | ${item.approval_status ? 'âœ… ì„ ìƒë‹˜ í™•ì¸ì™„ë£Œ' : 'ì‘ì„±ì¤‘'}</div>
                `;
                div.onclick = () => openModal(item);
                list.appendChild(div);
            });
        }

        function focusAndScroll(allowAutoScroll) {
            const input = document.getElementById('compositionInput');
            if (input) {
                input.focus({ preventScroll: true });
            }

            if (allowAutoScroll) {
                const activeCell = document.querySelector('.student-cell.active');
                if (activeCell) {
                    const rect = activeCell.getBoundingClientRect();
                    const viewHeight = (window.innerHeight || document.documentElement.clientHeight);
                    const margin = 60; 

                    const isOutOfView = (rect.top < margin) || (rect.bottom > viewHeight - margin);

                    if (isOutOfView) {
                        activeCell.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                }
            }
        }

        async function openModal(item) {
            currentManuscriptId = item.id;
            currentCols = item.cols;
            
            if (currentCols === 20) {
                currentRows = 20; 
            } else if (currentCols === 25) {
                currentRows = 28; 
            } else {
                currentRows = 20;
            }

            document.getElementById('editTitle').textContent = item.title;
            document.getElementById('editModal').classList.add('show');
            
            render_paper_rs(currentRows, currentCols);
            init_input_state(currentRows, currentCols); 
            
            const studentContent = item.content || "";
            originalContent = studentContent;
            hasUnsavedChanges = false;
            
            let teacherContent = "";
            let markingContent = "[]";

            if (item.approval_status) {
                if (item.modified_text) teacherContent = item.modified_text;
                if (item.error_text) markingContent = item.error_text;
            }
            
            currentErrorText = markingContent;

            try {
                load_full_data_rs(studentContent, teacherContent, markingContent, currentCols); 
            } catch (e) {
                console.error("ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜:", e);
                fill_grid_content(studentContent, "student", currentCols);
            }
            
            currentLayer = "student";
            switch_layer_rs("student");
            updateLayerButton();
            document.getElementById('hideEmptyRowsCheck').checked = false;

            set_cursor_pos(0);
            
            setTimeout(() => {
                focusAndScroll(true);
            }, 100);
        }
        
        function updateLayerButton() {
            const btn = document.getElementById('layerToggleBtn');
            if (currentLayer === "student") {
                btn.className = 'layer-toggle-btn student-active';
                btn.textContent = 'í•™ìƒëª¨ë“œ ( Tab )';
            } else {
                btn.className = 'layer-toggle-btn teacher-active';
                btn.textContent = 'ì²¨ì‚­ ëª¨ë“œ ( Tab )';
            }
        }
        
        function toggleLayer() {
            force_stop_composition();
            if (currentLayer === "student") {
                currentLayer = "teacher";
                switch_layer_rs('teacher');
                setTimeout(() => { 
                    draw_markings_rs(currentErrorText, currentCols); 
                    focusAndScroll(false); 
                }, 350);
            } else {
                currentLayer = "student";
                switch_layer_rs('student');
                clear_markings_rs(); 
                setTimeout(() => {
                    focusAndScroll(false); 
                }, 50);
            }
            updateLayerButton();
        }

        function closeModal() {
            force_stop_composition();
            
            if (hasUnsavedChanges) {
                if (!confirm("ì €ì¥í•˜ì§€ ì•Šì€ ë³€ê²½ì‚¬í•­ì´ ìˆìŠµë‹ˆë‹¤. ì •ë§ ë‹«ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    return;
                }
            }
            
            document.getElementById('editModal').classList.remove('show');
            currentManuscriptId = null;
            currentLayer = "student";
            hasUnsavedChanges = false;
            originalContent = "";
        }

        function markAsChanged() {
            hasUnsavedChanges = true;
        }

        function setupEventListeners() {
            document.getElementById('loginBtn').addEventListener('click', async () => {
                const cls = document.getElementById('studentClass').value;
                const name = document.getElementById('studentName').value;
                const pw = document.getElementById('studentPassword').value;
                try {
                    const res = await login_student(name, cls, pw);
                    showStudentArea(res.student_name, res.class);
                } catch (err) { alert(err); }
            });
            
            document.getElementById('logoutBtn').addEventListener('click', () => { 
                logout_student(); 
                showLoginArea(); 
            });
            
            document.getElementById('refreshBtn').addEventListener('click', loadData);
            
            document.getElementById('createBtn').addEventListener('click', async () => {
                const title = document.getElementById('newTitle').value.trim();
                const typeVal = document.getElementById('newCols').value; 
                if (!title) { alert("ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
                const cols = parseInt(typeVal.split('_')[0]);
                
                try {
                    const newManuscript = await create_new_manuscript(title, cols);
                    alert("ì›ê³ ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    document.getElementById('newTitle').value = "";
                    loadData(); 
                    if (newManuscript) {
                        openModal(newManuscript);
                    }
                } catch(err) { alert(err); }
            });

            document.getElementById('closeModalBtn').addEventListener('click', closeModal);
            document.getElementById('closeBtnBottom').addEventListener('click', closeModal);
            document.getElementById('layerToggleBtn').addEventListener('click', toggleLayer);
            
            document.getElementById('undoBtn').addEventListener('click', () => {
                undo();
                markAsChanged();
                setTimeout(() => focusAndScroll(true), 0); 
            });
            
            document.getElementById('redoBtn').addEventListener('click', () => {
                redo();
                markAsChanged();
                setTimeout(() => focusAndScroll(true), 0); 
            });

            document.addEventListener('keydown', (e) => {
                const isModalOpen = document.getElementById('editModal').classList.contains('show');
                if (e.key === 'Tab' && isModalOpen) {
                    e.preventDefault();
                    toggleLayer();
                }
                if (isModalOpen) {
                    if ((e.ctrlKey || e.metaKey) && (e.key === 'z' || e.key === 'Z')) { 
                        e.preventDefault(); 
                        if (e.shiftKey) redo(); 
                        else undo(); 
                        markAsChanged();
                        return; 
                    }
                    if ((e.ctrlKey || e.metaKey) && (e.key === 'y' || e.key === 'Y')) { 
                        e.preventDefault(); 
                        redo(); 
                        markAsChanged();
                        return; 
                    }
                    if ((e.ctrlKey || e.metaKey) && e.code === 'KeyC') { 
                        e.preventDefault(); 
                        const text = get_selected_text(); 
                        if (text) navigator.clipboard.writeText(text); 
                        return; 
                    }
                    if ((e.ctrlKey || e.metaKey) && e.code === 'KeyV') { 
                        e.preventDefault(); 
                        navigator.clipboard.readText().then(text => { 
                            if (text) {
                                paste_text_at_cursor(text); 
                                markAsChanged();
                            }
                        }); 
                        return; 
                    }
                    if ((e.ctrlKey || e.metaKey) && e.code === 'KeyX') { 
                        e.preventDefault(); 
                        const text = get_selected_text(); 
                        if (text) { 
                            navigator.clipboard.writeText(text).then(() => { 
                                delete_selected_cells(); 
                                markAsChanged();
                            }); 
                        } 
                        return; 
                    }
                }
            });
            
            document.getElementById('hideEmptyRowsCheck').addEventListener('change', (e) => {
                toggle_empty_rows_rs(e.target.checked);
                if (currentLayer === "teacher") {
                    setTimeout(() => { draw_markings_rs(currentErrorText, currentCols); }, 350);
                }
            });

            document.getElementById('saveBtn').addEventListener('click', async () => {
                force_stop_composition();
                if (!currentManuscriptId) return;
                try {
                    const content = read_grid_content(currentRows, currentCols);
                    await save_student_content(currentManuscriptId, content);
                    alert("ì›ê³ ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    hasUnsavedChanges = false;
                    originalContent = content;
                    loadData();
                } catch (err) { alert(err); }
            });

            const paper = document.getElementById('manuscriptPaper');
            
            paper.addEventListener('mousedown', (e) => {
                const cell = e.target.closest('.student-cell');
                if (cell) {
                    const idx = parseInt(cell.dataset.index);
                    if (!isNaN(idx)) {
                        force_stop_composition();
                        handle_cell_mousedown(idx, e.shiftKey);
                        setTimeout(() => focusAndScroll(false), 0);
                    }
                }
            });
            
            paper.addEventListener('mouseover', (e) => {
                const cell = e.target.closest('.student-cell');
                if (cell) {
                    const idx = parseInt(cell.dataset.index);
                    handle_cell_mouseenter(idx);
                }
            });
            
            window.addEventListener('mouseup', () => { handle_global_mouseup(); });

            paper.addEventListener('compositionstart', (e) => {
                if (e.target.id !== 'compositionInput') return; 
                handle_composition_start();
            });
            
            paper.addEventListener('compositionupdate', (e) => {
                if (e.target.id !== 'compositionInput') return; 
                handle_composition_update(e.data);
            });
            
            paper.addEventListener('compositionend', (e) => {
                if (e.target.id !== 'compositionInput') return; 
                handle_composition_end(e.data);
                markAsChanged();
                setTimeout(() => focusAndScroll(true), 0);
            });
            
            paper.addEventListener('input', (e) => {
                if (e.target.id !== 'compositionInput') return;
                if (e.isComposing) return;
                if (e.data) {
                    handle_input_event(e.data);
                    markAsChanged();
                    setTimeout(() => focusAndScroll(true), 0);
                }
            });
            
            paper.addEventListener('keydown', (e) => {
                if (e.target.id !== 'compositionInput') return;
                if (e.key === 'Tab') return; 
                handle_keydown(e);
                markAsChanged();
                setTimeout(() => focusAndScroll(true), 0);
            });
            
            paper.addEventListener('click', (e) => {
                if (e.target.classList.contains('memo-toggle-btn')) {
                    const idx = e.target.dataset.markIndex;
                    const box = document.querySelector(`.memo-box[data-mark-index='${idx}']`);
                    if (box) box.classList.toggle('expanded');
                }
            });
        }
        
        window.addEventListener('resize', () => {
            if (currentLayer === "teacher" && document.getElementById('editModal').classList.contains('show')) {
                draw_markings_rs(currentErrorText, currentCols);
            }
        });
    </script>
</body>
</html>